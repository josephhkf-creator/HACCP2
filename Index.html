<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeFood SaaS Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .soft-tone { background-color: #f0fdf4; color: #166534; } /* Soft Green */
        .tab-btn.active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
        .hidden-section { display: none; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold mb-6 text-green-700 text-center">Food Safety Portal</h2>
            <div class="space-y-4">
                <input type="text" id="loginId" placeholder="Company ID" class="w-full border p-3 rounded focus:ring-2 focus:ring-green-500 outline-none">
                <input type="password" id="loginPass" placeholder="Password" class="w-full border p-3 rounded focus:ring-2 focus:ring-green-500 outline-none">
                <select id="loginRole" class="w-full border p-3 rounded bg-gray-50">
                    <option value="Admin">System Admin</option>
                    <option value="Client">Client User</option>
                    <option value="Visitor">Visitor (View Only)</option>
                </select>
                <button onclick="handleLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded transition">Secure Login</button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden">Invalid Credentials</p>
                <div id="loginLoader" class="spinner hidden"></div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden-section min-h-screen flex flex-col">
        
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="bg-green-100 p-2 rounded-full">
                        <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800" id="headerCompanyName">Loading...</h1>
                        <p class="text-xs text-gray-500" id="headerActivity">Food Safety Dashboard</p>
                    </div>
                </div>
                <button onclick="window.location.reload()" class="text-sm text-red-500 hover:text-red-700">Logout</button>
            </div>
            
            <div class="container mx-auto px-4 mt-4 flex space-x-6 overflow-x-auto">
                <button onclick="switchTab('kyc')" id="tab-kyc" class="tab-btn pb-2 px-1 text-gray-500 hover:text-green-600 transition">KYC Profile</button>
                <button onclick="switchTab('forms')" id="tab-forms" class="tab-btn pb-2 px-1 text-gray-500 hover:text-green-600 transition">Operational Forms</button>
                <button onclick="switchTab('reports')" id="tab-reports" class="tab-btn pb-2 px-1 text-gray-500 hover:text-green-600 transition">Reports & Trends</button>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-8">
            
            <div id="view-kyc" class="hidden-section">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center">
                        <h3 class="text-green-800 font-semibold">Company Overview</h3>
                        <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">Active Contract</span>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div><label class="text-xs uppercase text-gray-400 font-bold">Certification</label><p id="kycCert" class="text-lg text-gray-700 font-medium">-</p></div>
                            <div><label class="text-xs uppercase text-gray-400 font-bold">Contract Number</label><p id="kycContract" class="text-gray-700">-</p></div>
                            <div><label class="text-xs uppercase text-gray-400 font-bold">Service Cover</label><p id="kycService" class="text-gray-700">-</p></div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="text-xs uppercase text-gray-400 font-bold">Contact Person</label><p id="kycContact" class="text-gray-700">-</p></div>
                            <div><label class="text-xs uppercase text-gray-400 font-bold">Last Data Input</label><p id="kycLast" class="text-gray-700">-</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-forms" class="hidden-section">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm space-y-2 h-fit">
                        <h4 class="font-bold text-gray-500 text-sm uppercase mb-2">Select Register</h4>
                        <button onclick="loadForm('incoming')" class="w-full text-left p-2 rounded hover:bg-gray-50 text-sm">Incoming Materials</button>
                        <button onclick="loadForm('haccp')" class="w-full text-left p-2 rounded hover:bg-gray-50 text-sm">HACCP Production</button>
                        <button onclick="loadForm('visitor')" class="w-full text-left p-2 rounded hover:bg-gray-50 text-sm">Visitors Declaration</button>
                        <button onclick="loadForm('maintenance')" class="w-full text-left p-2 rounded hover:bg-gray-50 text-sm">Maintenance Log</button>
                        <hr class="my-2">
                        <p class="text-xs text-gray-400 text-center">Static Pages (Demo)</p>
                        <button class="w-full text-left p-2 rounded hover:bg-gray-50 text-sm text-gray-400">Cleaning Schedule</button>
                    </div>

                    <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <h2 id="formTitle" class="text-xl font-bold mb-4 text-gray-800">Select a form from the menu</h2>
                        <form id="activeForm" class="space-y-4 hidden-section" onsubmit="submitForm(event)">
                            <div id="formFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            <button type="submit" id="submitBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 mt-4">Submit Entry</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-reports" class="hidden-section">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">System Reports</h2>
                    <div class="space-x-2">
                        <button onclick="window.print()" class="bg-gray-800 text-white px-3 py-1 rounded text-sm">Print / Save PDF</button>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded shadow mb-6">
                    <h3 class="font-bold text-gray-500 text-sm mb-4">Input Activity Trend</h3>
                    <div class="h-64"><canvas id="trendChart"></canvas></div>
                </div>

                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr id="reportHeader"></tr>
                        </thead>
                        <tbody id="reportBody"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = "https://script.google.com/macros/s/AKfycbxb_rQHw2CuOIebXfNb1CnGD5vHtLlj2XrY4cGGeCB5boWCdwZAbrw81AquoobmErQ/exec"; 
        
        let currentState = { companyId: '', role: '', sheetName: '' };
        
        // --- AUTHENTICATION ---
        async function handleLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const role = document.getElementById('loginRole').value;
            
            document.getElementById('loginLoader').classList.remove('hidden');
            
            try {
                // Fetch KYC data
                const response = await fetch(`${API_URL}?op=login&compId=${id}&pass=${pass}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentState.companyId = id;
                    currentState.role = role;
                    
                    // Populate KYC
                    const kyc = result.kyc;
                    document.getElementById('headerCompanyName').innerText = kyc.name;
                    document.getElementById('headerActivity').innerText = kyc.activity;
                    document.getElementById('kycCert').innerText = kyc.certification;
                    document.getElementById('kycContract').innerText = kyc.contract;
                    document.getElementById('kycService').innerText = kyc.service;
                    document.getElementById('kycContact').innerText = kyc.contact;
                    document.getElementById('kycLast').innerText = new Date(kyc.lastInput).toLocaleDateString();

                    // Role Restrictions
                    if (role === 'Visitor') {
                        document.getElementById('submitBtn').style.display = 'none';
                        document.getElementById('tab-forms').style.display = 'none'; // Visitors shouldn't see forms
                    }

                    // Switch UI
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden-section');
                    switchTab('kyc');
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                alert("Connection Error. Please check your internet or script URL.");
            } finally {
                document.getElementById('loginLoader').classList.add('hidden');
            }
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            ['kyc', 'forms', 'reports'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden-section');
                document.getElementById(`tab-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden-section');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if(tab === 'reports') loadReports();
        }

        // --- FORMS ENGINE ---
        function loadForm(type) {
            const container = document.getElementById('formFields');
            const form = document.getElementById('activeForm');
            const title = document.getElementById('formTitle');
            
            container.innerHTML = '';
            form.classList.remove('hidden-section');
            
            let fields = [];
            
            if (type === 'incoming') {
                currentState.sheetName = 'IncomingMaterials';
                title.innerText = "9. Register of Incoming Materials";
                fields = [
                    {label: 'Product Name', type: 'text', id: 'pname'},
                    {label: 'Brand', type: 'text', id: 'brand'},
                    {label: 'Weight (g/kg)', type: 'text', id: 'weight'},
                    {label: 'Chill Storage (1-8°C)', type: 'select', id: 'chill', opts: ['Yes','No','NA']},
                    {label: 'Cold Storage (<-14°C)', type: 'select', id: 'cold', opts: ['Yes','No','NA']},
                    {label: 'Expiry Date', type: 'date', id: 'expiry'},
                    {label: 'Packaging Integrity', type: 'select', id: 'pack', opts: ['Intact','Bulged','Damaged']},
                    {label: 'Product Integrity', type: 'select', id: 'prod', opts: ['Good','Spots','Off-odor']}
                ];
            } else if (type === 'haccp') {
                currentState.sheetName = 'HACCP';
                title.innerText = "HACCP Production Record";
                fields = [
                    {label: 'Product Description', type: 'text', id: 'desc'},
                    {label: 'Raw Mat List', type: 'text', id: 'rawlist'},
                    {label: 'Batch No', type: 'text', id: 'batch'},
                    {label: 'Quantity', type: 'number', id: 'qty'},
                    {label: 'CCP 1 Temp', type: 'text', id: 'ccp1'},
                    {label: 'CCP 2', type: 'text', id: 'ccp2'},
                    {label: 'Corrective Action', type: 'text', id: 'action'},
                    {label: 'Final Expiry', type: 'date', id: 'fexp'}
                ];
            } else if (type === 'visitor') {
                currentState.sheetName = 'Visitors';
                title.innerText = "Visitor Declaration";
                fields = [
                    {label: 'Visitor Name', type: 'text', id: 'vname'},
                    {label: 'Health Declaration (No Symptoms)', type: 'select', id: 'decl', opts: ['Yes', 'No']}
                ];
            } else if (type === 'maintenance') {
                currentState.sheetName = 'Maintenance';
                title.innerText = "Maintenance Log";
                fields = [
                    {label: 'Equipment Details', type: 'text', id: 'equip'},
                    {label: 'Intervention Description', type: 'text', id: 'interv'},
                    {label: 'Initiator (Initials)', type: 'text', id: 'init'}
                ];
            }

            // Render Fields
            fields.forEach(f => {
                let inputHtml = '';
                if (f.type === 'select') {
                    inputHtml = `<select name="${f.id}" class="w-full border p-2 rounded bg-gray-50">${f.opts.map(o => `<option>${o}</option>`).join('')}</select>`;
                } else {
                    inputHtml = `<input type="${f.type}" name="${f.id}" class="w-full border p-2 rounded" required>`;
                }
                container.innerHTML += `<div><label class="block text-sm font-bold text-gray-700 mb-1">${f.label}</label>${inputHtml}</div>`;
            });
        }

        async function submitForm(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            // Collect Data
            const formData = new FormData(e.target);
            const dataRow = [currentState.companyId, new Date().toISOString()]; // First two cols always ID & Date
            for (let [key, value] of formData.entries()) {
                dataRow.push(value);
            }
            // Add Role at end if needed
            dataRow.push(currentState.role);

            // Send to Google Sheet
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Standard for Google Script simple posts
                body: JSON.stringify({
                    op: 'submitForm',
                    sheetName: currentState.sheetName,
                    row: dataRow
                })
            });

            alert("Record Saved Successfully");
            btn.innerText = "Submit Entry";
            btn.disabled = false;
            e.target.reset();
        }

        // --- REPORTS & TRENDS ---
        async function loadReports() {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '<tr><td class="p-4">Loading data...</td></tr>';
            
            const response = await fetch(`${API_URL}?op=getReport&compId=${currentState.companyId}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                const logs = result.data.incoming; // Defaulting to incoming logs for the table
                
                // Clear Table
                tbody.innerHTML = '';
                document.getElementById('reportHeader').innerHTML = '<th class="px-6 py-3">Date</th><th class="px-6 py-3">Product</th><th class="px-6 py-3">Status</th>';

                // Populate Table (Last 10 entries)
                logs.slice(-10).forEach(row => {
                    // row indexes based on Sheet columns: [0]=ID, [1]=Date, [2]=ProdName, [3]=Brand...
                    const date = new Date(row[1]).toLocaleDateString();
                    const status = row[9] === 'Good' ? '<span class="text-green-600 font-bold">Pass</span>' : '<span class="text-red-600 font-bold">Check</span>';
                    
                    tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4">${date}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${row[2]} (${row[3]})</td>
                        <td class="px-6 py-4">${status}</td>
                    </tr>`;
                });

                // Render Chart (Simple count of logs per day)
                const ctx = document.getElementById('trendChart').getContext('2d');
                // Destroy old chart if exists (basic handling)
                // ... logic to aggregate dates ...
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                        datasets: [{
                            label: 'Forms Submitted',
                            data: [2, 5, 3, 8, 4], // Placeholder data for visual
                            borderColor: '#16a34a',
                            tension: 0.1
                        }]
                    }
                });
            }
        }
    </script>
</body>
</html>